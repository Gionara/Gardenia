{% extends 'shopWeb/layouts/base.html' %}
{% load static %}

<link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">

{% block title %} 游꺚Gardenia - Perfil 游꺚 {% endblock %}.

{% block content %}
<div class="container mt-5">
    <h2>Perfil de Usuario</h2>
    <div class="row">
        <div class="col-md-6">
            <h4>Datos Personales</h4>
            <ul class="list-group">
                <li class="list-group-item"><strong>Nombre:</strong> 
                    {{user.first_name }}</li>
                <li class="list-group-item"><strong>Apellido:</strong>
                     {{ user.last_name }}</li>
                <li class="list-group-item"><strong>Correo Electr칩nico:</strong>
                    {{ request.user.email }}</li>
            </ul>
        </div>

        <!-- CAMBIAR CONTRASE칌A -->
        <div class="col-md-6">
            <h4>Cambiar Contrase침a</h4>
            <form id="password_change_form" method="POST">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="id_old_password">Contrase침a Actual</label>
                    <input type="password" name="old_password" id="id_old_password" autocomplete="current-password" required>
                    <small class="text-danger" id="old_password_error"></small>
                </div>
        
                <div class="mb-3">
                    <label for="id_new_password1">Nueva Contrase침a</label>
                    <input type="password" name="new_password1" id="id_new_password1" autocomplete="new-password" required>
                    <small class="text-danger" id="new_password1_error"></small>
                </div>
        
                <div class="mb-3">
                    <label for="id_new_password2">Confirmar Nueva Contrase침a</label>
                    <input type="password" name="new_password2" id="id_new_password2" autocomplete="new-password" required>
                    <small class="text-danger" id="new_password2_error"></small>
                </div>
        
                <button type="submit" class="btn btn-primary">Actualizar Contrase침a</button>
            </form>
        </div>
        
        <div class="row mt-5">
            <div class="col-md-12">
                <h4>Suscripci칩n</h4>
                <div class="suscripcion-section">
                    {% if suscripcion  and suscripcion.activa%}
                        <p>Estas suscrito en apoyo a la Fundaci칩n Ni침os por Chile.</p>
                        <a href="{% url 'suscripcion' %}" class="btn btn-primary">Ver Suscripci칩n</a>
                    {% else %}
                        <p>A칰n no est치s suscrito. Ayuda a la Fundaci칩n Ni침os por Chile suscribi칠ndote.</p>
                        <a href="{% url 'suscripcion' %}" class="btn btn-primary">Suscribirse</a>
                    {% endif %}
                </div>

                           </div>            
        </div>
    </div>

    <div class="row mt-5">
        <div class="col-md-12">
            <h4>Direcciones de Env칤o</h4>
            {% if direcciones.exists %}
            <div class="list-group">
                {% for direccion in direcciones %}
                <div class="list-group-item">
                    <h6 class="mb-1">{{ direccion.nombre_dirreccion }}</h6>
                    <p class="mb-1">{{ direccion.direccion }}, {{ direccion.ciudad }}</p>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p>No tienes direcciones guardadas. <a href="{% url 'agregar_direccion' %}">Agregar direcci칩n de env칤o</a></p>
            {% endif %}
            <a href="{% url 'direcciones' %}" class="btn btn-info">Gestionar
                Direcciones</a>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function() {
    $('#password_change_form').submit(function(event) {
        event.preventDefault();

        let oldPassword = $('#id_old_password').val();
        let newPassword1 = $('#id_new_password1').val();
        let newPassword2 = $('#id_new_password2').val();
        let csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

        let isValid = true;

        // Reset error messages
        $('#old_password_error').text('');
        $('#new_password1_error').text('');
        $('#new_password2_error').text('');

        // Check if old password is not empty
        if (oldPassword === '') {
            $('#old_password_error').text('Este campo es requerido.');
            isValid = false;
        }

        // Check if new passwords match
        if (newPassword1 !== newPassword2) {
            $('#new_password2_error').text('Las contrase침as no coinciden.');
            isValid = false;
        }

        // Add more password validation if needed (length, complexity, etc.)
        if (newPassword1.length < 6) {
            $('#new_password1_error').text('La nueva contrase침a debe tener al menos 6 caracteres.');
            isValid = false;
        } else if (!validatePassword(newPassword1)) {
            $('#new_password1_error').text('La nueva contrase침a debe tener al menos una letra may칰scula, una letra min칰scula y un n칰mero.');
            isValid = false;
        } else {
            $('#new_password1_error').text('');
        }

        if (!isValid) {
            return;
        }

        function validatePassword(password) {
            var uppercaseRegex = /[A-Z]/;
            var numberRegex = /[0-9]/;
            return uppercaseRegex.test(password) && numberRegex.test(password);
        }

        $.ajax({
            type: 'POST',
            url: '{% url "profile" %}',
            data: {
                old_password: oldPassword,
                new_password1: newPassword1,
                new_password2: newPassword2,
                csrfmiddlewaretoken: csrfToken,
            },
            success: function(response) {
                if (response.error) {
                    for (let field in response.errors) {
                        if (field === 'old_password') {
                            $('#old_password_error').text(response.errors[field]);
                        } else if (field === 'new_password1') {
                            $('#new_password1_error').text(response.errors[field]);
                        } else if (field === 'new_password2') {
                            $('#new_password2_error').text(response.errors[field]);
                        }
                    }
                } else {
                    alert('춰Tu contrase침a ha sido actualizada correctamente!');
                    window.location.href = '{% url "profile" %}';
                }
            },
            error: function(xhr, status, error) {
                alert('Ha ocurrido un error, por favor intente de nuevo.');
            }
        });
    });
});
</script>
{% endblock %}
